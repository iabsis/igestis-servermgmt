#!/bin/bash

cwd=$(dirname "${BASH_SOURCE[0]}")

action=${1}
args=${@}

getfacl="/bin/getfacl"
setfacl="/bin/setfacl -m"
rmfacl="/bin/setfacl -x"
mkdir="/bin/mkdir -p"
mv="/bin/mv"
rmdir="/bin/rmdir"

getValueConfig()
{

grep "^$1[[:space:]]*=.*" ${cwd}/../config/config.ini | \
  cut -d= -f 2 | \
  cut -d" " -f 2 | \
  sed 's/\"//g'
}

case $action in

  getDataFolderAcl)

    aclList="$(${getfacl} $(getValueConfig DATA_FOLDER_MGMT)/* 2>/dev/null)"

    while IFS= read -r line ; do
        echo "${line}"
    done <<< "$aclList"

  ;;

  setDataFolderAcl)

    username="${2}"
    folder="${3}"
    right="${4}"

    case ${right} in
      read)
        ${setfacl} u:${username}:r-x $(getValueConfig DATA_FOLDER_MGMT)/${folder} 2>&1 || exit $?
      ;;
      write)
        ${setfacl} u:${username}:rwx $(getValueConfig DATA_FOLDER_MGMT)/${folder} 2>&1 || exit $?
      ;;
      none)
        ${rmfacl} u:${username} $(getValueConfig DATA_FOLDER_MGMT)/${folder} 2>&1 || exit $?
      ;;
      *)
        echo "Wrong right value, must be read, write or none." || exit 1
      ;;
    esac

  ;;

  createDataFolder)

    folder="${2}"

    if [ -d "$(getValueConfig DATA_FOLDER_MGMT)/${folder}" ] ; then
      echo "this folder already exists ${folder}"
      exit 1
    fi
    ${mkdir} "$(getValueConfig DATA_FOLDER_MGMT)/${folder}" 2>&1 || exit $?

  ;;

  renameDataFolder)

    folderOld="${2}"
    folderNew="${3}"
    ${mv} "$(getValueConfig DATA_FOLDER_MGMT)/${folderOld}" "$(getValueConfig DATA_FOLDER_MGMT)/${folderNew}" 2>&1 || exit $?

  ;;

  deleteDataFolder)


    folder="${2}"
    ${rmdir} "$(getValueConfig DATA_FOLDER_MGMT)/${folder}" 2>&1 || exit $?

  ;;


esac
